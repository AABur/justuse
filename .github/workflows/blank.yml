
name: Unit Tests


on:
  fork:
  pull_request:
    types: [opened, edited, closed]
  push:
  release:
    types: [published, created, edited, released]

jobs:
  test-ubuntu:
    runs-on: ubuntu-latest

    steps:
      - name: Linux Tests
        uses: actions/checkout@v2
      - run: |
          echo "Linux-Tests: Preloading package dependencies ..."
          python3 -m pip install anyio mmh3 mypy packaging pip pytest pytest-env pytest-cov requests types-toml types-requests yarl
          echo "Linux-Tests: Running tests ..."
          mkdir -p ~/.justuse-python/
          echo "debug = true" > ~/.justuse-python/config.toml
          env DEBUG=1 ERRORS=1 python3 -m pytest
          python3 -m pip install --force-reinstall --upgrade -r requirements.txt
          [ -e tests/coverage.sh ] && env DEBUG=1 ERRORS=1 bash ./tests/coverage.sh || env DEBUG=1 ERRORS=1 python3 -m pytest
    
      - name: coverage.py badge
        uses: tj-actions/coverage-badge-py@v1.6
        with:
          github-token: ${{ secrets.PAT_TOKEN }}


  test-windows:
    runs-on: windows-latest

    steps:
      - name: Run a multi-line script
        uses: actions/checkout@v2
      - run: |
          echo "Setting TLS security properties ..."
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          echo "Downloading recent Python 3 ..."
          Invoke-WebRequest -Uri "https://www.python.org/ftp/python/3.9.0/python-3.9.0.exe" -OutFile "c:/temp/python-3.9.0.exe"
          echo "Installing Python 3 ..."
          & "c:/temp/python-3.9.0.exe" /quiet InstallAllUsers=0 PrependPath=1 Include_test=0
          echo "Waiting for setup to complete ..."
          $env:PATH = "$env:LOCALAPPDATA\Programs\Python\Python39-32;$env:LOCALAPPDATA\Programs\Python\Python39-32\lib;$env:PATH"
          env
          while (!(Test-Path "$env:LOCALAPPDATA/Programs/Python/Python39-32/python.exe")) {
            Write-Host "Waiting for installation"
            [System.Threading.Thread]::Sleep(1000)
          }
          $pyver = ""
          while (!($pyver.Contains(" 3.9"))) {
            $pyver = $(
              & "$env:LOCALAPPDATA/Programs/Python/Python39-32/python.exe" -m pip --version || & { $global:LASTEXITCODE = 0; }
            ) -join "`n"
          }
          echo "Windows-Tests: Preloading package dependencies ..."
          & "$env:LOCALAPPDATA/Programs/Python/Python39-32/python.exe" -m pip install anyio mmh3 mypy packaging pip pytest pytest-env pytest-cov requests types-toml types-requests yarl
          echo "Windows-Tests: Running tests ..."
          $env:DEBUG = 1
          $env:ERRORS = 1
          & "$env:LOCALAPPDATA/Programs/Python/Python39-32/python.exe" -m pytest


  test-macos:
    runs-on: macos-latest

    steps:
      - name: Run a multi-line script
        uses: actions/checkout@v2
      - run: |
          echo "MacOS-Tests: Preloading package dependencies ..."
          python3 -m pip install anyio mmh3 mypy packaging pip pytest pytest-env pytest-cov requests types-toml types-requests yarl
          echo "MacOS-Tests: Running tests ..."
          mkdir -p ~/.justuse-python/
          echo "debug = true" > ~/.justuse-python/config.toml
          env DEBUG=1 ERRORS=1 python3 -m pytest
  
